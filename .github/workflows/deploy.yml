name: Deploy to Azure VM

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 手動実行も可能

env:
  DEPLOY_PATH: /home/azureuser/stock_agent
  VM_HOST: 20.222.241.22
  VM_USER: azureuser

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.VM_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via rsync
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '*.pem' \
            --exclude 'db/stock_agent.db' \
            --exclude 'logs/*' \
            --exclude '.env' \
            --exclude 'venv' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./ ${{ env.VM_USER }}@${{ env.VM_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Setup on remote server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.VM_USER }}@${{ env.VM_HOST }} << 'EOF'
          set -euo pipefail
          cd ${{ env.DEPLOY_PATH }}

          # Python仮想環境がなければ（または壊れていれば）作成
          if [ ! -f "venv/bin/activate" ]; then
            python3 -m venv venv
          fi

          # 依存パッケージインストール
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # DBディレクトリ作成
          mkdir -p db logs db/migrations

          # マイグレーション適用（新規・既存環境どちらも対応）
          python scripts/migrate.py apply
          echo "Database migrations applied"

          # Webサーバー（systemd）のセットアップ・再起動
          sudo -n cp infra/stock-agent-web.service /etc/systemd/system/
          sudo -n systemctl daemon-reload
          sudo -n systemctl enable stock-agent-web
          sudo -n systemctl restart stock-agent-web
          sleep 2
          sudo -n systemctl is-active --quiet stock-agent-web
          echo "Web server restarted"

          echo "Deployment completed successfully!"
          EOF

      - name: Apply crontab and set permissions
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ env.VM_USER }}@${{ env.VM_HOST }} << 'EOF'
          set -e
          chmod +x ${{ env.DEPLOY_PATH }}/infra/cleanup_logs.sh
          crontab ${{ env.DEPLOY_PATH }}/infra/crontab
          echo "Crontab applied:"
          crontab -l
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
